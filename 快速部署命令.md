# 动「QI」来 CRM - 快速部署命令参考

## 🚀 一键部署脚本

复制以下命令，粘贴到服务器终端，一次性完成所有部署步骤：

```bash
# 连接服务器
ssh root@172.93.32.222

# 进入项目目录
cd /root/dongqilai-crm

# 备份数据库
mkdir -p backups && pg_dump -U postgres dongqilai_db > backups/backup_$(date +%Y%m%d_%H%M%S).sql

# 拉取最新代码
git pull origin main

# 安装依赖
npm install

# 清理测试数据（只保留qixi账号）
npm run tsx server/clean-test-data.ts

# 同步数据库
npm run db:push

# 重启应用
pm2 restart dongqilai-crm

# 查看状态
pm2 status
pm2 logs dongqilai-crm --lines 30
```

---

## 📝 分步命令（推荐新手）

### 1. 连接服务器
```bash
ssh root@172.93.32.222
```

### 2. 进入项目
```bash
cd /root/dongqilai-crm
```

### 3. 备份数据库 ⭐
```bash
mkdir -p backups
pg_dump -U postgres dongqilai_db > backups/backup_$(date +%Y%m%d_%H%M%S).sql
```

### 4. 拉取代码
```bash
git pull origin main
```

### 5. 安装依赖
```bash
npm install
```

### 6. 清理测试数据 🧹
```bash
npm run tsx server/clean-test-data.ts
```
**这会删除所有客户和测试用户，只保留qixi主管账号**

### 7. 同步数据库
```bash
npm run db:push
```

### 8. 重启应用
```bash
pm2 restart dongqilai-crm
```

### 9. 检查状态
```bash
pm2 status
pm2 logs dongqilai-crm --lines 30
```

---

## 🔍 常用检查命令

### 查看应用状态
```bash
pm2 status
```

### 查看实时日志
```bash
pm2 logs dongqilai-crm
```

### 查看最近50行日志
```bash
pm2 logs dongqilai-crm --lines 50
```

### 查看错误日志
```bash
pm2 logs dongqilai-crm --err --lines 50
```

### 实时监控
```bash
pm2 monit
```

---

## 🔄 常用管理命令

### 重启应用
```bash
pm2 restart dongqilai-crm
```

### 停止应用
```bash
pm2 stop dongqilai-crm
```

### 启动应用
```bash
pm2 start dongqilai-crm
```

### 查看应用详情
```bash
pm2 show dongqilai-crm
```

---

## 🛠 故障排查命令

### 问题：应用无法启动

```bash
# 1. 查看错误日志
pm2 logs dongqilai-crm --err --lines 100

# 2. 检查端口占用
lsof -i :5000

# 3. 手动启动测试
cd /root/dongqilai-crm
npm run dev
```

### 问题：数据库连接失败

```bash
# 测试数据库连接
psql -U postgres -d dongqilai_db

# 检查数据库是否存在
psql -U postgres -l | grep dongqilai
```

### 问题：Nginx 502错误

```bash
# 检查Nginx配置
nginx -t

# 重启Nginx
systemctl reload nginx

# 查看Nginx日志
tail -f /var/log/nginx/error.log
```

---

## 🔙 回滚命令

如果新版本有问题，回滚到之前版本：

```bash
# 1. 查看历史版本
git log --oneline -10

# 2. 回滚到指定版本（替换为实际commit hash）
git reset --hard <commit-hash>

# 3. 恢复数据库（替换为实际备份文件名）
psql -U postgres dongqilai_db < backups/backup_YYYYMMDD_HHMMSS.sql

# 4. 重新安装依赖
npm install

# 5. 重启应用
pm2 restart dongqilai-crm
```

---

## ✅ 快速验证

访问：https://app.detusts.com

登录账号：
- 用户名：`qixi`
- 密码：`hu626388`

检查：
- [ ] 欢迎语显示正确（七夕或您的昵称）
- [ ] 客户列表为空（测试数据已清理）
- [ ] 可以添加新客户
- [ ] AI功能正常
- [ ] 团队群聊实时通信
- [ ] 标签颜色正确

---

## 💡 提示

1. **每次部署前都要备份数据库**
2. **清理脚本只运行一次**（部署到生产环境时）
3. **话术库分类**需要在网页上手动管理
4. **如有问题**，先查看日志：`pm2 logs dongqilai-crm`

---

## 📞 紧急联系

如果遇到严重问题：

1. 立即停止应用：`pm2 stop dongqilai-crm`
2. 恢复数据库备份
3. 回滚到上一个版本
4. 联系技术支持

---

**服务器**: 172.93.32.222  
**域名**: https://app.detusts.com  
**管理员**: qixi / hu626388
