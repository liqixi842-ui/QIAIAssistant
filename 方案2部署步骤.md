# 🚀 动「QI」来 1.0 - 方案2部署完整步骤

## 📋 总体流程（30分钟完成）

```
Replit → GitHub/Gitee私有仓库 → 您的服务器
```

---

## 第一部分：在Replit中设置Git（5分钟）

### 步骤1：连接Git仓库

#### 选项A：使用GitHub（推荐）

1. 在Replit左侧栏点击 **Version Control** 图标（像树枝的图标）
2. 点击 **"Connect to GitHub"**
3. 授权Replit访问GitHub
4. 创建新仓库：
   - 仓库名：`dongqilai` 
   - **重要：选择 "Private"（私有）** ✅
   - 描述：动「QI」来 1.0 - 智能CRM系统
5. 点击 **"Create repository"**

#### 选项B：使用Gitee（国内速度更快）

1. 先去 https://gitee.com 注册账号
2. 创建新仓库：
   - 仓库名：`dongqilai`
   - **选择"私有"** ✅
3. 在Replit中：
   - 点击左侧 Version Control
   - 选择 "Initialize git repository"
   - 添加远程仓库：
   ```bash
   git remote add origin https://gitee.com/您的用户名/dongqilai.git
   ```

### 步骤2：提交代码到仓库

在Replit中：

1. 点击 Version Control 面板
2. 写提交消息：`初始提交 - 动「QI」来 1.0`
3. 点击 **"Commit & push"**

✅ **完成！** 代码已安全保存到私有Git仓库

---

## 第二部分：在服务器上部署（20分钟）

### 步骤1：SSH登录到您的服务器

```bash
ssh root@您的服务器IP地址
```

### 步骤2：安装环境（自动化）

复制以下命令，一次性粘贴执行：

```bash
# 更新系统
apt update && apt upgrade -y

# 安装 Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs

# 安装 Nginx
apt install -y nginx

# 安装 PM2
npm install -g pm2

# 安装 Git
apt install -y git

# 配置防火墙
ufw --force enable
ufw allow ssh
ufw allow 80
ufw allow 443

# 安装 Certbot（SSL证书工具）
apt install -y certbot python3-certbot-nginx

echo "✓ 环境安装完成！"
```

### 步骤3：设置SSH密钥（用于安全克隆仓库）

#### 如果使用GitHub：

```bash
# 生成SSH密钥
ssh-keygen -t ed25519 -C "your_email@example.com"
# 按3次回车（使用默认设置，不设密码）

# 显示公钥
cat ~/.ssh/id_ed25519.pub
```

**复制显示的公钥**，然后：
1. 打开 https://github.com/settings/keys
2. 点击 **"New SSH key"**
3. 粘贴公钥
4. 点击 **"Add SSH key"**

#### 如果使用Gitee：

```bash
# 生成SSH密钥（同上）
ssh-keygen -t ed25519 -C "your_email@example.com"
cat ~/.ssh/id_ed25519.pub
```

**复制显示的公钥**，然后：
1. 打开 https://gitee.com/profile/sshkeys
2. 点击 **"添加公钥"**
3. 粘贴公钥
4. 点击 **"确定"**

### 步骤4：克隆项目到服务器

```bash
# 创建项目目录
mkdir -p /var/www
cd /var/www

# 克隆您的私有仓库（选择对应的命令）

# GitHub:
git clone git@github.com:您的GitHub用户名/dongqilai.git

# Gitee:
git clone git@gitee.com:您的Gitee用户名/dongqilai.git

# 进入项目目录
cd dongqilai
```

### 步骤5：安装项目依赖

```bash
# 安装生产环境依赖
npm install --production

# 或者如果需要所有依赖（包括开发依赖）
npm install
```

### 步骤6：配置环境变量（重要！）

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量
nano .env
```

**在打开的编辑器中，修改以下内容：**

找到这几行并修改：

```bash
SESSION_SECRET=your-random-secret-key-change-this-in-production
```
改成一个随机字符串，比如：
```bash
SESSION_SECRET=dongqilai2025mycrmsecurekeyabcd1234
```

找到：
```bash
AI_INTEGRATIONS_OPENAI_API_KEY=your-skynetchat-api-key-here
```
改成您真实的 skynetchat.io API密钥：
```bash
AI_INTEGRATIONS_OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxx
```

**保存并退出**：
- 按 `Ctrl + X`
- 按 `Y`
- 按 `Enter`

### 步骤7：启动应用

```bash
# 使用PM2启动（使用配置文件）
pm2 start ecosystem.config.js

# 保存PM2配置
pm2 save

# 设置开机自启动
pm2 startup
# 会显示一条命令，复制并执行它

# 查看运行状态
pm2 status
```

您应该看到类似这样的输出：
```
┌─────┬────────────────┬─────────┬─────────┐
│ id  │ name           │ status  │ cpu     │
├─────┼────────────────┼─────────┼─────────┤
│ 0   │ dongqilai-1.0  │ online  │ 0%      │
└─────┴────────────────┴─────────┴─────────┘
```

### 步骤8：配置Nginx

```bash
# 编辑Nginx配置
nano nginx.conf
```

找到这一行：
```nginx
server_name YOUR_DOMAIN_OR_IP;
```

**改成您的实际IP或域名**：

如果只用IP：
```nginx
server_name 123.45.67.89;  # 您的服务器IP
```

如果有域名：
```nginx
server_name yourdomain.com www.yourdomain.com;
```

保存后：

```bash
# 复制配置文件到Nginx目录
cp nginx.conf /etc/nginx/sites-available/dongqilai

# 创建软链接
ln -s /etc/nginx/sites-available/dongqilai /etc/nginx/sites-enabled/

# 测试配置
nginx -t

# 如果显示 "test is successful"，重启Nginx
systemctl restart nginx
```

### 步骤9：访问应用

**浏览器打开**：`http://您的服务器IP`

**使用主管账号登录测试**：
- 用户名：`qixi`
- 密码：`hu626388`

✅ **如果能登录，部署成功！**

---

## 第三部分：配置域名和HTTPS（可选，10分钟）

### 如果您有域名：

#### 1. 配置DNS解析

在您的域名提供商（阿里云/腾讯云等）：

- **类型**：A记录
- **主机记录**：@ （或 www）
- **记录值**：您的服务器IP
- **TTL**：600

等待DNS生效（5-10分钟）

#### 2. 测试域名

```bash
# 测试域名是否解析到服务器
ping yourdomain.com
```

#### 3. 安装SSL证书（免费，自动续期）

```bash
# 一键安装SSL证书
certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 按提示操作：
# 1. 输入邮箱
# 2. 同意服务条款
# 3. 选择 2（重定向HTTP到HTTPS）
```

✅ **完成！** 现在访问 `https://yourdomain.com` 就是安全的HTTPS了！

---

## ✅ 部署完成检查清单

- [ ] Git仓库已创建（私有）
- [ ] 代码已推送到仓库
- [ ] 服务器环境已安装（Node.js、Nginx、PM2）
- [ ] SSH密钥已添加到GitHub/Gitee
- [ ] 项目已克隆到 `/var/www/dongqilai`
- [ ] `.env` 文件已配置（API密钥、SESSION_SECRET）
- [ ] PM2 已启动应用（`pm2 status` 显示 online）
- [ ] Nginx 已配置并重启
- [ ] 浏览器可以访问应用
- [ ] 主管账号可以登录（qixi/hu626388）
- [ ] （可选）域名已配置
- [ ] （可选）SSL证书已安装

---

## 🔧 日常维护命令

### 查看应用状态
```bash
pm2 status
pm2 logs dongqilai-1.0
```

### 更新应用（有新版本时）
```bash
cd /var/www/dongqilai
git pull origin main
npm install --production
pm2 restart dongqilai-1.0
```

### 重启应用
```bash
pm2 restart dongqilai-1.0
```

### 查看日志
```bash
pm2 logs dongqilai-1.0 --lines 100
```

---

## 🆘 遇到问题？

### 问题1：无法访问应用

```bash
# 检查PM2状态
pm2 status

# 查看错误日志
pm2 logs dongqilai-1.0 --err

# 检查防火墙
ufw status

# 检查Nginx
systemctl status nginx
nginx -t
```

### 问题2：Git克隆失败

```bash
# 确认SSH密钥已添加
ssh -T git@github.com
# 或
ssh -T git@gitee.com

# 如果失败，重新生成密钥
ssh-keygen -t ed25519 -C "your_email@example.com" -f ~/.ssh/id_ed25519 -N ""
cat ~/.ssh/id_ed25519.pub
```

### 问题3：AI功能不工作

```bash
# 检查环境变量
cat .env | grep AI_

# 确认API密钥正确
# 重启应用
pm2 restart dongqilai-1.0
```

---

## 📞 需要帮助？

**维护版本**：动「QI」来 1.0

需要技术支持时，请说：**"需要维护动「QI」来 1.0"**

提供这些信息会帮助更快解决问题：
- 错误截图
- PM2日志：`pm2 logs dongqilai-1.0 --lines 50`
- Nginx错误日志：`tail -50 /var/log/nginx/dongqilai-error.log`

---

**祝部署顺利！** 🎉

有任何问题随时找我！
