# 动「QI」来 CRM系统 - 部署教学

## 📋 部署前准备

### 服务器信息
- **服务器IP**: 172.93.32.222
- **域名**: app.detusts.com
- **管理员账号**: qixi / hu626388
- **项目路径**: /root/dongqilai-crm

### 前提条件
- ✅ 服务器已安装Node.js 18+
- ✅ 服务器已安装PostgreSQL
- ✅ 服务器已安装PM2
- ✅ 域名已解析到服务器IP
- ✅ Nginx已配置（支持WebSocket）

---

## 🚀 部署步骤（一步一步来）

### 第1步：连接到服务器

打开终端（或SSH工具），输入：

```bash
ssh root@172.93.32.222
```

输入服务器密码后，你会看到命令行变成：

```
root@your-server:~#
```

这表示已成功连接到服务器。

---

### 第2步：进入项目目录

```bash
cd /root/dongqilai-crm
```

验证路径是否正确：

```bash
pwd
```

应该显示：`/root/dongqilai-crm`

---

### 第3步：查看当前状态

先查看当前代码状态：

```bash
git status
```

这会显示有哪些文件被修改了。

---

### 第4步：备份数据库（重要！）

在做任何更改之前，先备份数据库：

```bash
# 创建备份目录
mkdir -p backups

# 备份数据库（自动包含日期时间）
pg_dump -U postgres dongqilai_db > backups/backup_$(date +%Y%m%d_%H%M%S).sql
```

执行后会在`backups`目录下生成一个备份文件，例如：
`backup_20241023_163000.sql`

---

### 第5步：拉取最新代码

```bash
git pull origin main
```

如果提示有冲突，可以强制覆盖（会丢失本地修改）：

```bash
git fetch origin
git reset --hard origin/main
```

---

### 第6步：安装依赖

```bash
npm install
```

等待安装完成（可能需要1-2分钟）。

---

### 第7步：清理测试数据 ⭐

**重要：这一步会删除所有测试数据，只保留主管账号qixi**

执行清理脚本：

```bash
npm run tsx server/clean-test-data.ts
```

你会看到如下输出：

```
🧹 开始清理测试数据...

📋 删除所有客户数据...
✅ 已删除所有客户数据

👥 删除测试用户（保留主管账号qixi）...
✅ 已删除测试用户（保留qixi账号）

🔍 验证主管账号...
✅ 主管账号验证通过:
   用户名: qixi
   姓名: 七夕
   角色: 主管
   ID: xxxxxxxx

📊 清理结果汇总:
   ✅ 客户数据: 已全部删除
   ✅ 测试用户: 已全部删除
   ✅ 主管账号: 已保留（qixi）

🎉 测试数据清理完成！
```

**注意**：话术库和学习资料的分类（如图片中的"基础培训"、"市场分析"等）不在数据库中，是前端代码控制的。如果需要删除这些分类，需要修改代码或在生产环境中手动管理。

---

### 第8步：同步数据库schema

```bash
npm run db:push
```

这个命令会自动同步数据库结构，不会丢失数据。

如果遇到错误，可以强制同步：

```bash
npm run db:push --force
```

---

### 第9步：重启应用

```bash
pm2 restart dongqilai-crm
```

或者如果PM2配置文件是其他名字，使用：

```bash
pm2 restart all
```

---

### 第10步：检查应用状态

```bash
pm2 status
```

你会看到类似这样的输出：

```
┌─────┬──────────────────┬─────────────┬─────────┬─────────┬──────────┐
│ id  │ name             │ mode        │ ↺       │ status  │ cpu      │
├─────┼──────────────────┼─────────────┼─────────┼─────────┼──────────┤
│ 0   │ dongqilai-crm    │ fork        │ 0       │ online  │ 0%       │
└─────┴──────────────────┴─────────────┴─────────┴─────────┴──────────┘
```

**status应该是"online"**，表示应用正常运行。

---

### 第11步：查看应用日志

```bash
pm2 logs dongqilai-crm --lines 50
```

应该看到类似：

```
WebSocket服务器已启动在路径 /ws
4:47:11 PM [express] serving on port 5000
```

**如果看到错误信息，请复制错误日志联系技术支持。**

---

## ✅ 验证部署（必做！）

### 1. 打开浏览器

访问：https://app.detusts.com

### 2. 测试登录

使用主管账号登录：
- 用户名：`qixi`
- 密码：`hu626388`

### 3. 验证功能清单

登录成功后，逐一检查以下功能：

#### ✅ Dashboard（控制台）
- [ ] 欢迎语显示"欢迎回来，七夕！"（或您的昵称）
- [ ] 不显示"张伟"
- [ ] 数据统计显示正常

#### ✅ 客户管理
- [ ] 客户列表为空（已清理测试数据）
- [ ] 可以添加新客户
- [ ] 客户标签颜色清晰：
  - 未跟进 = 灰色
  - 跟进中 = 蓝色
  - 已成交 = 绿色

#### ✅ AI客户分析
- [ ] 点击客户详情
- [ ] 点击"AI分析"按钮
- [ ] 输入对话内容
- [ ] 收到AI分析结果（不是占位符）

#### ✅ 团队群聊
- [ ] 打开团队群聊页面
- [ ] 发送消息
- [ ] 消息立即显示（实时通信）

#### ✅ AI助手
- [ ] 提问关于金融销售的问题
- [ ] 收到专业回复

#### ✅ 话术库 & 学习资料
- [ ] 话术库分类可以查看
- [ ] 学习资料可以查看
- [ ] **如需删除测试分类（如图片中的分类），在页面上手动删除即可**

---

## 🔧 常见问题排查

### 问题1：无法连接服务器

**症状**：`ssh: connect to host 172.93.32.222 port 22: Connection refused`

**解决**：
1. 检查服务器IP是否正确
2. 检查网络连接
3. 联系服务器管理员

---

### 问题2：PM2显示状态"errored"

**症状**：`pm2 status` 显示status为"errored"

**解决**：
```bash
# 查看详细错误
pm2 logs dongqilai-crm --err --lines 100

# 常见原因：
# - 数据库连接失败 → 检查DATABASE_URL环境变量
# - 端口被占用 → 检查5000端口
# - 依赖缺失 → 重新运行npm install
```

---

### 问题3：网页显示502错误

**症状**：访问https://app.detusts.com显示502 Bad Gateway

**解决**：
```bash
# 1. 检查应用是否运行
pm2 status

# 2. 检查Nginx配置
nginx -t

# 3. 重启Nginx
systemctl reload nginx

# 4. 重启应用
pm2 restart dongqilai-crm
```

---

### 问题4：WebSocket连接失败

**症状**：团队群聊无法实时更新

**解决**：检查Nginx配置是否支持WebSocket

```bash
# 编辑Nginx配置
nano /etc/nginx/sites-available/app.detusts.com
```

确保有以下配置：

```nginx
location /ws {
    proxy_pass http://localhost:5000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

保存后重启Nginx：

```bash
nginx -t
systemctl reload nginx
```

---

### 问题5：AI功能不工作

**症状**：AI分析或AI助手无响应

**解决**：
```bash
# 检查环境变量
echo $OPENAI_API_KEY
echo $AI_API_KEY

# 如果为空，需要配置
# 在项目目录创建.env文件或在PM2配置中添加
```

---

## 🔄 如何回滚（如果部署出问题）

如果新版本有问题，可以回滚到之前的版本：

```bash
# 1. 查看git历史
git log --oneline -10

# 2. 回滚到指定commit（替换<commit-hash>为实际的commit哈希）
git reset --hard <commit-hash>

# 3. 恢复数据库备份
psql -U postgres dongqilai_db < backups/backup_YYYYMMDD_HHMMSS.sql

# 4. 重新安装依赖
npm install

# 5. 重启应用
pm2 restart dongqilai-crm
```

---

## 📞 需要帮助？

如果遇到问题：

1. **先查看日志**：
   ```bash
   pm2 logs dongqilai-crm --lines 100
   ```

2. **检查应用状态**：
   ```bash
   pm2 status
   pm2 monit  # 实时监控
   ```

3. **复制错误信息**并联系技术支持

---

## ✅ 部署完成确认

请逐项确认：

- [ ] 服务器SSH连接成功
- [ ] 代码拉取到最新版本
- [ ] 测试数据已清理（只保留qixi账号）
- [ ] 数据库已备份
- [ ] 依赖已安装
- [ ] 数据库schema已同步
- [ ] PM2状态显示"online"
- [ ] 应用日志无严重错误
- [ ] 网页可以正常访问
- [ ] 登录功能正常
- [ ] Dashboard欢迎语正确
- [ ] 客户管理功能正常
- [ ] AI客户分析功能正常
- [ ] 团队群聊实时通信正常
- [ ] AI助手回复正常
- [ ] 标签颜色显示正确

---

## 🎯 下一步

部署完成后，您可以：

1. **创建团队成员账号**
   - 登录后进入"团队管理"页面
   - 添加业务、经理、总监等角色

2. **导入客户数据**
   - 进入"客户管理"
   - 手动添加或批量导入客户

3. **配置话术库**
   - 删除测试分类
   - 添加实际使用的话术

4. **开始使用**
   - 培训团队成员
   - 开始使用CRM管理客户

---

**部署日期**: ___________

**部署人员**: ___________

**验证人员**: ___________

**系统状态**: ___________
